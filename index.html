<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Métodos Numéricos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/function-plot/1.23.2/function-plot.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .input-section {
            flex: 1;
            min-width: 300px;
        }

        .result-section {
            flex: 2;
            min-width: 300px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .result-card {
            margin-top: 20px;
            display: none;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            color: var(--text-color);
            font-weight: 500;
            transition: all 0.3s;
            width: auto;
            margin-top: 0;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .tab-content {
            display: none;
            padding: 15px 0;
        }

        .tab-content.active {
            display: block;
        }

        #result-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 10px;
            text-align: center;
        }

        #error-message {
            color: var(--accent-color);
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        #graph-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        .method-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Calculadora de Métodos Numéricos</h1>
        </header>

        <div class="main-content">
            <div class="card input-section">
                <h2>Parámetros de entrada</h2>
                <div class="form-group">
                    <label for="method">Método de integración:</label>
                    <select id="method">
                        <option value="trapezoidal">Método Trapezoidal</option>
                        <option value="simpson13">Método Simpson 1/3</option>
                        <option value="simpson38">Método Simpson 3/8</option>
                        <option value="boole">Método Jorge Boole</option>
                        <option value="simpson_open">Método Simpson Abierto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="function">Función f(x):</label>
                    <input type="text" id="function" placeholder="Ej: x^2 + 2*x + 1" value="x^2 + 2*x + 1">
                </div>
                <div class="form-group">
                    <label for="a">Límite inferior (a):</label>
                    <input type="number" id="a" placeholder="Ej: 0" value="0">
                </div>
                <div class="form-group">
                    <label for="b">Límite superior (b):</label>
                    <input type="number" id="b" placeholder="Ej: 1" value="1">
                </div>
                <div class="form-group">
                    <label for="n">Número de subdivisiones (n):</label>
                    <input type="number" id="n" placeholder="Ej: 10" value="10" min="2">
                </div>
                <button id="calculate-btn">Calcular</button>
                <div id="error-message"></div>

                <div class="method-info" id="method-info"></div>
            </div>

            <div class="card result-section">
                <div class="result-card" id="result-card">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="result-tab">Resultado</button>
                        <button class="tab-btn" data-tab="graph-tab">Gráfica</button>
                    </div>

                    <div class="tab-content active" id="result-tab">
                        <h3>Resultado de la integración</h3>
                        <div id="method-name"></div>
                        <div id="result-value"></div>
                        <div id="result-details"></div>
                        <div id="iterations-table-container" style="margin-top: 20px;"></div> <!-- ✅ movido adentro -->
                    </div>

                    <div class="tab-content" id="graph-tab">
                        <h3>Visualización gráfica</h3>
                        <div id="graph-container"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Referencias a elementos del DOM
            const methodSelect = document.getElementById('method');
            const functionInput = document.getElementById('function');
            const aInput = document.getElementById('a');
            const bInput = document.getElementById('b');
            const nInput = document.getElementById('n');
            const calculateBtn = document.getElementById('calculate-btn');
            const resultCard = document.getElementById('result-card');
            const methodNameElement = document.getElementById('method-name');
            const resultValueElement = document.getElementById('result-value');
            const resultDetailsElement = document.getElementById('result-details');
            const graphContainer = document.getElementById('graph-container');
            const errorMessage = document.getElementById('error-message');
            const methodInfoElement = document.getElementById('method-info');
            
            // Información sobre los métodos
            const methodInfo = {
                trapezoidal: "El método trapezoidal aproxima la integral dividiendo el área en trapecios. Es simple pero menos preciso para funciones no lineales.",
                simpson13: "El método Simpson 1/3 usa polinomios de segundo grado para aproximar la función. Requiere un número par de subdivisiones.",
                simpson38: "El método Simpson 3/8 utiliza polinomios de tercer grado. Es más preciso que el método 1/3 para ciertas funciones.",
                boole: "El método de Boole utiliza polinomios de quinto grado para aproximar la función. Es muy preciso para funciones suaves.",
                simpson_open: "El método Simpson Abierto no utiliza los extremos del intervalo, lo que lo hace útil cuando la función tiene singularidades en los límites."
            };

            // Actualizar información del método cuando cambia la selección
            methodSelect.addEventListener('change', function() {
                methodInfoElement.textContent = methodInfo[this.value];
                
                // Validar número de subdivisiones según el método
                validateSubdivisions();
            });
            
            // Mostrar la información inicial del método
            methodInfoElement.textContent = methodInfo[methodSelect.value];

            // Función para validar el número de subdivisiones según el método
            function validateSubdivisions() {
                const method = methodSelect.value;
                const n = parseInt(nInput.value);
                
                switch(method) {
                    case 'simpson13':
                        if (n % 2 !== 0) {
                            nInput.setCustomValidity('El método Simpson 1/3 requiere un número par de subdivisiones');
                        } else {
                            nInput.setCustomValidity('');
                        }
                        break;
                    case 'simpson38':
                        if (n % 3 !== 0) {
                            nInput.setCustomValidity('El método Simpson 3/8 requiere que el número de subdivisiones sea múltiplo de 3');
                        } else {
                            nInput.setCustomValidity('');
                        }
                        break;
                    case 'boole':
                        if (n % 4 !== 0) {
                            nInput.setCustomValidity('El método de Boole requiere que el número de subdivisiones sea múltiplo de 4');
                        } else {
                            nInput.setCustomValidity('');
                        }
                        break;
                    default:
                        nInput.setCustomValidity('');
                }
            }

            // Manejar tabs
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remover clase active de todos los botones y contenidos
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Añadir clase active al botón clicado y su contenido correspondiente
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Si es la pestaña de gráfica, actualizar el gráfico
                    if (tabId === 'graph-tab') {
                        updateGraph();
                    }
                });
            });

            // Función para calcular la integral
           calculateBtn.addEventListener('click', function () {
        try {
            validateSubdivisions();
            if (!functionInput.value || !aInput.value || !bInput.value || !nInput.value) {
                throw new Error('Por favor, complete todos los campos');
            }

            if (nInput.validity.customError) {
                throw new Error(nInput.validationMessage);
            }

            const data = {
                method: methodSelect.value,
                function: functionInput.value,
                a: parseFloat(aInput.value),
                b: parseFloat(bInput.value),
                n: parseInt(nInput.value)
            };

            // Validamos que solo esté activo si el método es trapezoidal (único implementado en backend)
            if (data.method !== 'trapezoidal') {
                throw new Error('Por ahora solo está disponible el Método Trapezoidal con la API.');
            }

            errorMessage.style.display = 'none';

            // Llamada real al backend
            fetch('http://localhost:8080/api/integracion/trapezoidal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': '*/*'
                },
                body: JSON.stringify({
                    a: data.a,
                    b: data.b,
                    n: data.n,
                    funcion: data.function
                })
            })
                .then(res => {
                    if (!res.ok) throw new Error("Error al comunicarse con el servidor");
                    return res.json();
                })
                .then(apiResponse => {
                    const response = {
                        success: true,
                        result: apiResponse.result,
                        details: apiResponse.details,
                        iterations: apiResponse.iterations,
                        points: apiResponse.iterations.map(item => ({ x: item.xi, y: item.fxi }))
                    };
                    displayResults(data, response);
                })
                .catch(error => {
                    errorMessage.textContent = error.message;
                    errorMessage.style.display = 'block';
                    resultCard.style.display = 'none';
                });

        } catch (error) {
            errorMessage.textContent = error.message;
            errorMessage.style.display = 'block';
            resultCard.style.display = 'none';
        }
    });
           

            /* Función auxiliar para calcular una integral exacta de algunas funciones comunes
            function calculateExactIntegral(functionStr, a, b) {
                // Para demostración, devolvemos un valor aproximado para x^2 + 2x + 1
                // En una implementación real, esto sería más sofisticado o vendría de la API
                if (functionStr === 'x^2 + 2*x + 1') {
                    // Integral de x^2 + 2x + 1 es x^3/3 + x^2 + x
                    const evalAt = (x) => x**3/3 + x**2 + x;
                    return evalAt(b) - evalAt(a);
                }
                // Para otras funciones, devolvemos un valor aleatorio para demostración
                return Math.random() * 10;
            } */

            // Función para mostrar los resultados
            function displayResults(data, response) {
                if (!response.success) {
                    errorMessage.textContent = response.error || 'Ocurrió un error en el cálculo';
                    errorMessage.style.display = 'block';
                    resultCard.style.display = 'none';
                    return;
                }
                
                // Mostrar la tarjeta de resultados
                resultCard.style.display = 'block';
                
                // Establecer el nombre del método
                const methodNames = {
                    trapezoidal: 'Método Trapezoidal',
                    simpson13: 'Método Simpson 1/3',
                    simpson38: 'Método Simpson 3/8',
                    boole: 'Método Jorge Boole',
                    simpson_open: 'Método Simpson Abierto'
                };
                methodNameElement.textContent = methodNames[data.method];
                
                // Mostrar el resultado de la integración
                resultValueElement.textContent = response.result.toFixed(6);
                
                

                                // Mostrar tabla de iteraciones si existen
                const tableContainer = document.getElementById('iterations-table-container');
                if (response.iterations && response.iterations.length > 0) {
                    let tableHTML = `
                        <h4>Tabla de Iteraciones</h4>
                        <table style="width: 100%; border-collapse: collapse; text-align: center;">
                            <thead>
                                <tr style="background-color: #f0f0f0;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">i</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">xᵢ</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">f(xᵢ)</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Término</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                    `;
                    

                    response.iterations.forEach(iter => {
                        tableHTML += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${iter.i}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${iter.xi}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${iter.fxi}</td>  
                                <td style="padding: 8px; border: 1px solid #ddd;">${iter.term}</td>
                            </tr>
                        `;
                    });

                    tableHTML += `
                            </tbody>
                        </table>
                    `;

                    tableContainer.innerHTML = tableHTML;
                } else {
                    tableContainer.innerHTML = '';
                }

                
                // Actualizar la gráfica si la pestaña está activa
                if (document.getElementById('graph-tab').classList.contains('active')) {
                    updateGraph();
                }
            }

            // Función para actualizar la gráfica
            function updateGraph() {
                try {
                    const functionStr = functionInput.value;
                    const a = parseFloat(aInput.value);
                    const b = parseFloat(bInput.value);
                    
                    // Limpiar el contenedor
                    graphContainer.innerHTML = '';
                    
                    // Crear gráfica usando function-plot
                    functionPlot({
                        target: '#graph-container',
                        width: graphContainer.offsetWidth,
                        height: 400,
                        yAxis: { domain: [-10, 10] },
                        xAxis: { domain: [Math.min(a - 1, -1), Math.max(b + 1, 3)] },
                        grid: true,
                        data: [
                            {
                                fn: functionStr,
                                color: '#3498db'
                            },
                            {
                                points: [
                                    [a, 0],
                                    [b, 0]
                                ],
                                fnType: 'points',
                                graphType: 'scatter',
                                color: '#e74c3c'
                            }
                        ],
                        annotations: [
                            {
                                x: a,
                                text: 'a = ' + a
                            },
                            {
                                x: b,
                                text: 'b = ' + b
                            }
                        ]
                    });
                } catch (error) {
                    graphContainer.innerHTML = `<p style="color: red; text-align: center;">Error al generar la gráfica: ${error.message}</p>`;
                }
            }

            // Validar inputs cuando cambian
            nInput.addEventListener('input', validateSubdivisions);
        });
    </script>
</body>
</html>